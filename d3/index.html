<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D3.js Smooth Skewed Rectangles</title>
    <script src="https://d3js.org/d3.v5.min.js"></script>
</head>
<body>
    <svg width="1000" height="500" id="visualization"></svg>

    <script>
        // Select the SVG container
        const svg = d3.select("#visualization");

        // Set the dimensions and angles for each rectangle
        const x0 = 100;
        const y = 100;
        const h1 = 100; // height of L1 and L3
        const h2 = 65;  // height of L2
        const angle = 90 + 45;
        const translationStep = 2;

        // Load the CSV file asynchronously
        d3.csv("ev_df.csv").then(data => {
            

            // Initialize variables for iterating through the CSV rows
            let i = 0;
            let currentRow = data[i];
            
            // Find the maximum value of idx in the CSV file
            const maxIdx = d3.max(data, d => +d.idx);

            // Define colors for each season
            const seasonColors = {
                spring: "rgba(231, 99, 117, 0.9)",
                summer: "rgba(244, 184, 10, 0.9)",
                fall: "rgba(26, 41, 57, 0.9)",
                winter: "rgba(99, 180, 189, 0.9)",
            };

            // Iterate up to the maximum value of idx (inclusive)
            for (let idx = 0; idx <= maxIdx; idx++) {

                // Check if "idx" matches the current index in the CSV
                if (+currentRow.idx === idx) {
                    // Calculate the end point of L2 for each rectangle
                    const x = x0 + idx * translationStep;
                    const x2 = x + h2 * Math.cos((-angle) * (Math.PI / 180));
                    const y2 = y + h1 + h2 * Math.sin(angle * (Math.PI / 180));

                    // Determine line thickness, fill color, and dashed property based on conditions
                    const isDashed = currentRow.is_dashed === "True";
                    const currentThickness = +currentRow.deaths || 1;
                    const fillColor = "rgba(255, 255, 255, 0.3)";
                    const dashLength = isDashed ? 2 : 0; // Adjust the dash length

                    // Append a path for each rectangle
                    svg.append("path")
                        .attr("d", d3.line().curve(d3.curveLinearClosed)([
                            [x, y],
                            [x, y + h1 + 0.5], // Slightly overlap the joint
                            [x2, y2],
                            [x2, y2 - h1 - 0.5], // Slightly overlap the joint
                        ]))
                        .style("stroke", seasonColors[currentRow.season])
                        .style("stroke-width", isDashed ? currentThickness / 2 : currentThickness)
                        .style("fill", fillColor)
                        .style("stroke-dasharray", isDashed ? `${dashLength} ${dashLength}` : "none")
                        .style("stroke-linejoin", "round"); // Set line join property

                    // Move to the next row in the CSV
                    i++;
                    currentRow = data[i];
                }
            }
        });
    </script>
</body>
</html>
